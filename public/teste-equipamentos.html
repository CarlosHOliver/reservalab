<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste API Equipamentos</title>
</head>
<body>
    <h1>Teste API Equipamentos</h1>
    <button onclick="testarAPI()">Testar Buscar Equipamentos</button>
    <button onclick="inserirDadosTeste()">Inserir Dados de Teste</button>
    <div id="resultado"></div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/js/umd/supabase.js"></script>
    <script src="assets/js/config.js"></script>
    <script src="assets/js/api.js"></script>
    
    <script>
        async function testarAPI() {
            console.log('Testando API...');
            const resultado = document.getElementById('resultado');
            
            try {
                // Testar conexão com Supabase
                console.log('Supabase client:', supabase);
                
                // Testar consulta direta dos equipamentos
                console.log('Testando consulta direta...');
                const { data: equipamentosRaw, error: errorRaw } = await supabase
                    .from('equipamentos')
                    .select('*');
                    
                console.log('Equipamentos raw:', equipamentosRaw);
                console.log('Error raw:', errorRaw);
                
                // Testar consulta com join
                console.log('Testando consulta com join...');
                const { data: equipamentosJoin, error: errorJoin } = await supabase
                    .from('equipamentos')
                    .select(`
                        *,
                        blocos (nome)
                    `);
                    
                console.log('Equipamentos join:', equipamentosJoin);
                console.log('Error join:', errorJoin);
                
                // Testar busca de equipamentos via API
                const resultadoEquipamentos = await API.buscarEquipamentos();
                console.log('Resultado equipamentos API:', resultadoEquipamentos);
                
                // Testar busca de blocos
                const resultadoBlocos = await API.buscarBlocos();
                console.log('Resultado blocos:', resultadoBlocos);
                
                resultado.innerHTML = `
                    <h3>Resultados:</h3>
                    <h4>Equipamentos Raw (${equipamentosRaw?.length || 0}):</h4>
                    <pre>${JSON.stringify(equipamentosRaw, null, 2)}</pre>
                    
                    <h4>Equipamentos Join (${equipamentosJoin?.length || 0}):</h4>
                    <pre>${JSON.stringify(equipamentosJoin, null, 2)}</pre>
                    
                    <h4>Equipamentos API:</h4>
                    <pre>${JSON.stringify(resultadoEquipamentos, null, 2)}</pre>
                    
                    <h4>Blocos (${resultadoBlocos?.dados?.length || 0}):</h4>
                    <pre>${JSON.stringify(resultadoBlocos, null, 2)}</pre>
                `;
                
            } catch (error) {
                console.error('Erro no teste:', error);
                resultado.innerHTML = `<p style="color: red;">Erro: ${error.message}</p>`;
            }
        }
        
        async function inserirDadosTeste() {
            console.log('Inserindo dados de teste...');
            const resultado = document.getElementById('resultado');
            
            try {
                // Primeiro inserir blocos se não existirem
                const { data: blocosExistentes } = await supabase
                    .from('blocos')
                    .select('*');
                
                console.log('Blocos existentes:', blocosExistentes);
                
                if (!blocosExistentes || blocosExistentes.length === 0) {
                    console.log('Inserindo blocos...');
                    const { data: blocosInseridos, error: errorBlocos } = await supabase
                        .from('blocos')
                        .insert([
                            { nome: 'Bloco A - Administrativa' },
                            { nome: 'Bloco B - Salas de Aula' },
                            { nome: 'Bloco C - Laboratórios' }
                        ])
                        .select();
                    
                    console.log('Blocos inseridos:', blocosInseridos);
                    if (errorBlocos) console.error('Erro ao inserir blocos:', errorBlocos);
                }
                
                // Buscar blocos novamente
                const { data: blocos } = await supabase
                    .from('blocos')
                    .select('*');
                
                console.log('Blocos disponíveis:', blocos);
                
                if (blocos && blocos.length > 0) {
                    const blocoC = blocos.find(b => b.nome.includes('Laboratórios'));
                    const blocoA = blocos.find(b => b.nome.includes('Administrativa'));
                    
                    if (blocoC && blocoA) {
                        console.log('Inserindo equipamentos...');
                        const { data: equipamentosInseridos, error: errorEquipamentos } = await supabase
                            .from('equipamentos')
                            .insert([
                                {
                                    nome: 'Projetor Epson',
                                    patrimonio: 'PROJ001',
                                    bloco_id: blocoC.id,
                                    local: 'Lab. Informática 1',
                                    descricao: 'Projetor para apresentações',
                                    permitir_uso_compartilhado: true,
                                    necessita_acompanhamento: false,
                                    status: 'disponivel'
                                },
                                {
                                    nome: 'Notebook Dell',
                                    patrimonio: 'NOTE001',
                                    bloco_id: blocoC.id,
                                    local: 'Lab. Informática 2',
                                    descricao: 'Notebook para demonstrações',
                                    permitir_uso_compartilhado: true,
                                    necessita_acompanhamento: true,
                                    status: 'disponivel'
                                },
                                {
                                    nome: 'Câmera Fotográfica',
                                    patrimonio: 'CAM001',
                                    bloco_id: blocoA.id,
                                    local: 'Sala de Reuniões',
                                    descricao: 'Câmera para eventos',
                                    permitir_uso_compartilhado: false,
                                    necessita_acompanhamento: true,
                                    status: 'disponivel'
                                }
                            ])
                            .select();
                        
                        console.log('Equipamentos inseridos:', equipamentosInseridos);
                        if (errorEquipamentos) console.error('Erro ao inserir equipamentos:', errorEquipamentos);
                        
                        resultado.innerHTML = `
                            <div style="color: green;">
                                <h3>Dados de teste inseridos com sucesso!</h3>
                                <p>Blocos: ${blocos.length}</p>
                                <p>Equipamentos inseridos: ${equipamentosInseridos?.length || 0}</p>
                            </div>
                        `;
                    }
                }
                
            } catch (error) {
                console.error('Erro ao inserir dados de teste:', error);
                resultado.innerHTML = `<p style="color: red;">Erro ao inserir dados: ${error.message}</p>`;
            }
        }
    </script>
</body>
</html>
