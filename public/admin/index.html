<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Administrativa - ReservaLAB FAEN/UFGD</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <!-- CSS Customizado -->
    <link href="../assets/css/style.css" rel="stylesheet">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="../assets/images/favicon.ico">
</head>
<body>
    <!-- Header -->
    <header class="bg-primary text-white py-3 shadow-sm">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <div class="d-flex align-items-center">
                        <img src="../assets/images/logo-ufgd.png" alt="UFGD" class="me-3" style="height: 50px;">
                        <div>
                            <h1 class="h4 mb-0">ReservaLAB</h1>
                            <small class="opacity-75">Dashboard Administrativa - FAEN/UFGD</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 text-end" id="userInfo" style="display: none;">
                    <span class="me-3">Bem-vindo, <strong id="userName"></strong></span>
                    <button class="btn btn-outline-light btn-sm" onclick="logout()">
                        <i class="bi bi-box-arrow-right"></i> Sair
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Tela de Login -->
    <div id="loginScreen" class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="card shadow">
                    <div class="card-header bg-primary text-white">
                        <h3 class="mb-0"><i class="bi bi-shield-lock"></i> Acesso Administrativo</h3>
                    </div>
                    <div class="card-body p-4">
                        <form id="loginForm">
                            <div class="mb-3">
                                <label for="loginUser" class="form-label">Login:</label>
                                <input type="text" class="form-control" id="loginUser" required>
                            </div>
                            <div class="mb-3">
                                <label for="loginPassword" class="form-label">Senha:</label>
                                <input type="password" class="form-control" id="loginPassword" required>
                            </div>
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="bi bi-box-arrow-in-right"></i> Entrar
                            </button>
                        </form>
                        <div id="loginError" class="alert alert-danger mt-3" style="display: none;"></div>
                        <div class="mt-3 text-center">
                            <small class="text-muted">
                                Para ter acesso, solicite suas credenciais ao administrador do sistema.
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard Principal -->
    <div id="dashboardScreen" style="display: none;">
        <!-- Navegação -->
        <nav class="bg-light py-2 border-bottom">
            <div class="container">
                <ul class="nav nav-pills">
                    <li class="nav-item">
                        <a class="nav-link active" href="#" onclick="showSection('dashboard')">
                            <i class="bi bi-speedometer2"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showSection('reservas')">
                            <i class="bi bi-calendar-check"></i> Reservas
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showSection('laboratorios')">
                            <i class="bi bi-building"></i> Laboratórios
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showSection('equipamentos')">
                            <i class="bi bi-tools"></i> Equipamentos
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showSection('usuarios')">
                            <i class="bi bi-people"></i> Usuários
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showSection('formularios')">
                            <i class="bi bi-file-text"></i> Formulários
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showSection('configuracoes')">
                            <i class="bi bi-gear"></i> Configurações
                        </a>
                    </li>
                </ul>
            </div>
        </nav>

        <div class="container mt-4">
            <!-- Seção Dashboard -->
            <div id="section-dashboard" class="dashboard-section">
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <i class="bi bi-clock-history text-warning" style="font-size: 2rem;"></i>
                                <h4 class="mt-2" id="totalPendentes">0</h4>
                                <p class="text-muted">Reservas Pendentes</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <i class="bi bi-check-circle text-success" style="font-size: 2rem;"></i>
                                <h4 class="mt-2" id="totalAprovadas">0</h4>
                                <p class="text-muted">Reservas Aprovadas</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <i class="bi bi-building text-primary" style="font-size: 2rem;"></i>
                                <h4 class="mt-2" id="totalLaboratorios">0</h4>
                                <p class="text-muted">Laboratórios</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <i class="bi bi-tools text-info" style="font-size: 2rem;"></i>
                                <h4 class="mt-2" id="totalEquipamentos">0</h4>
                                <p class="text-muted">Equipamentos</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0"><i class="bi bi-clock-history"></i> Reservas Pendentes</h5>
                            </div>
                            <div class="card-body">
                                <div id="reservasPendentes">
                                    <p class="text-muted text-center">Carregando...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header bg-info text-white">
                                <h5 class="mb-0"><i class="bi bi-graph-up"></i> Estatísticas do Mês</h5>
                            </div>
                            <div class="card-body">
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Total de Reservas:</span>
                                    <strong id="estatTotalMes">0</strong>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Taxa de Aprovação:</span>
                                    <strong id="estatTaxaAprovacao">0%</strong>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Laboratório Mais Usado:</span>
                                    <strong id="estatLabMaisUsado">-</strong>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span>Equipamento Mais Usado:</span>
                                    <strong id="estatEquipMaisUsado">-</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Seção Reservas -->
            <div id="section-reservas" class="dashboard-section" style="display: none;">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="bi bi-calendar-check"></i> Gerenciar Reservas</h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <select class="form-control" id="filtroStatus">
                                    <option value="">Todos os Status</option>
                                    <option value="pendente">Pendentes</option>
                                    <option value="aprovada">Aprovadas</option>
                                    <option value="rejeitada">Rejeitadas</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <input type="date" class="form-control" id="filtroData">
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-primary" onclick="filtrarReservas()">
                                    <i class="bi bi-search"></i> Filtrar
                                </button>
                                <button class="btn btn-secondary" onclick="exportarReservas()">
                                    <i class="bi bi-download"></i> Exportar
                                </button>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Protocolo</th>
                                        <th>Solicitante</th>
                                        <th>Data/Hora</th>
                                        <th>Recurso</th>
                                        <th>Status</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="tabelaReservas">
                                    <tr>
                                        <td colspan="6" class="text-center">Carregando...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Seção Laboratórios -->
            <div id="section-laboratorios" class="dashboard-section" style="display: none;">
                <div class="card">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-building"></i> Gerenciar Laboratórios</h5>
                        <button class="btn btn-light" onclick="novoLaboratorio()">
                            <i class="bi bi-plus"></i> Novo Laboratório
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Nome</th>
                                        <th>Bloco</th>
                                        <th>Capacidade</th>
                                        <th>Status</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="tabelaLaboratorios">
                                    <tr>
                                        <td colspan="5" class="text-center">Carregando...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Seção Equipamentos -->
            <div id="section-equipamentos" class="dashboard-section" style="display: none;">
                <div class="card">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-tools"></i> Gerenciar Equipamentos</h5>
                        <button class="btn btn-light" onclick="novoEquipamento()">
                            <i class="bi bi-plus"></i> Novo Equipamento
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Nome</th>
                                        <th>Patrimônio</th>
                                        <th>Bloco</th>
                                        <th>Local</th>
                                        <th>Status</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="tabelaEquipamentos">
                                    <tr>
                                        <td colspan="6" class="text-center">Carregando...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Seção Usuários -->
            <div id="section-usuarios" class="dashboard-section" style="display: none;">
                <div class="card">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-people"></i> Gerenciar Usuários</h5>
                        <button class="btn btn-light" onclick="novoUsuario()">
                            <i class="bi bi-plus"></i> Novo Usuário
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Nome</th>
                                        <th>Login</th>
                                        <th>E-mail</th>
                                        <th>Perfil</th>
                                        <th>Bloco</th>
                                        <th>Status</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="tabelaUsuarios">
                                    <tr>
                                        <td colspan="7" class="text-center">Carregando...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Seção Formulários -->
            <div id="section-formularios" class="dashboard-section" style="display: none;">
                <div class="card">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-file-text"></i> Formulários de Acesso</h5>
                        <button class="btn btn-light" onclick="novoFormulario()">
                            <i class="bi bi-plus"></i> Novo Formulário
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Título</th>
                                        <th>URL</th>
                                        <th>Status</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="tabelaFormularios">
                                    <tr>
                                        <td colspan="4" class="text-center">Carregando...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Seção Configurações -->
            <div id="section-configuracoes" class="dashboard-section" style="display: none;">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0"><i class="bi bi-gear"></i> Configurações Gerais</h5>
                            </div>
                            <div class="card-body">
                                <form id="formConfiguracoes">
                                    <div class="mb-3">
                                        <label for="horarioInicio" class="form-label">Horário de Expediente - Início:</label>
                                        <input type="time" class="form-control" id="horarioInicio">
                                    </div>
                                    <div class="mb-3">
                                        <label for="horarioFim" class="form-label">Horário de Expediente - Fim:</label>
                                        <input type="time" class="form-control" id="horarioFim">
                                    </div>
                                    <div class="mb-3">
                                        <label for="diasExpediente" class="form-label">Dias de Expediente:</label>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" value="1" id="seg">
                                            <label class="form-check-label" for="seg">Segunda-feira</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" value="2" id="ter">
                                            <label class="form-check-label" for="ter">Terça-feira</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" value="3" id="qua">
                                            <label class="form-check-label" for="qua">Quarta-feira</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" value="4" id="qui">
                                            <label class="form-check-label" for="qui">Quinta-feira</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" value="5" id="sex">
                                            <label class="form-check-label" for="sex">Sexta-feira</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" value="6" id="sab">
                                            <label class="form-check-label" for="sab">Sábado</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" value="7" id="dom">
                                            <label class="form-check-label" for="dom">Domingo</label>
                                        </div>
                                    </div>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-check"></i> Salvar Configurações
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header bg-warning text-dark">
                                <h5 class="mb-0"><i class="bi bi-shield-lock"></i> Alterar Senha</h5>
                            </div>
                            <div class="card-body">
                                <form id="formAlterarSenha">
                                    <div class="mb-3">
                                        <label for="senhaAtual" class="form-label">Senha Atual:</label>
                                        <input type="password" class="form-control" id="senhaAtual" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="novaSenha" class="form-label">Nova Senha:</label>
                                        <input type="password" class="form-control" id="novaSenha" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="confirmarSenha" class="form-label">Confirmar Nova Senha:</label>
                                        <input type="password" class="form-control" id="confirmarSenha" required>
                                    </div>
                                    <button type="submit" class="btn btn-warning">
                                        <i class="bi bi-key"></i> Alterar Senha
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Detalhes da Reserva -->
    <div class="modal fade" id="modalDetalhesReserva" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Detalhes da Reserva</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="detalhesReservaContent">
                    <!-- Conteúdo será preenchido dinamicamente -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    <button type="button" class="btn btn-success" id="btnAprovar" onclick="aprovarReserva()" style="display: none;">
                        <i class="bi bi-check"></i> Aprovar
                    </button>
                    <button type="button" class="btn btn-danger" id="btnRejeitar" onclick="mostrarMotivoRejeicao()" style="display: none;">
                        <i class="bi bi-x"></i> Rejeitar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Motivo Rejeição -->
    <div class="modal fade" id="modalMotivoRejeicao" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">Motivo da Rejeição</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="motivoRejeicao" class="form-label">Informe o motivo da rejeição:</label>
                        <textarea class="form-control" id="motivoRejeicao" rows="4" required placeholder="Descreva o motivo da rejeição da reserva..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" onclick="rejeitarReserva()">
                        <i class="bi bi-x"></i> Confirmar Rejeição
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-light text-center py-3 mt-5">
        <div class="container">
            <p class="text-muted mb-0">
                Desenvolvido por Carlos Henrique C. de Oliveira - Laboratórios de Informática - FAEN/UFGD 2025
            </p>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.js"></script>
    
    <!-- Luxon para manipulação de datas com timezone -->
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
    
    <!-- BCrypt para verificação de hash de senhas - Múltiplas opções de fallback -->
    <script>
        // Tentar carregar bcrypt de múltiplas fontes
        const loadBcrypt = () => {
            const scripts = [
                'https://cdnjs.cloudflare.com/ajax/libs/bcryptjs/2.4.3/bcrypt.min.js',
                'https://cdn.jsdelivr.net/npm/bcryptjs@2.4.3/dist/bcrypt.min.js',
                'https://unpkg.com/bcryptjs@2.4.3/dist/bcrypt.min.js'
            ];
            
            let index = 0;
            
            function tryLoad() {
                if (index >= scripts.length) {
                    console.error('❌ ERRO: Não foi possível carregar bcrypt de nenhuma fonte');
                    alert('Erro: Biblioteca bcrypt não pode ser carregada. Verifique sua conexão.');
                    return;
                }
                
                const script = document.createElement('script');
                script.src = scripts[index];
                script.onload = () => {
                    console.log('✅ bcrypt carregado com sucesso de:', scripts[index]);
                };
                script.onerror = () => {
                    console.warn('⚠️ Falha ao carregar bcrypt de:', scripts[index]);
                    index++;
                    tryLoad();
                };
                document.head.appendChild(script);
            }
            
            tryLoad();
        };
        
        loadBcrypt();
    </script>
    
    <script>
        // Verificar se as bibliotecas foram carregadas após um delay
        setTimeout(() => {
            if (typeof window.supabase === 'undefined') {
                console.error('❌ ERRO: Biblioteca Supabase não carregada');
                alert('Erro: Biblioteca Supabase não foi carregada. Verifique sua conexão.');
            } else {
                console.log('✅ Supabase carregado');
            }
            
            if (typeof bcrypt === 'undefined' && typeof dcodeIO === 'undefined' && typeof window.bcrypt === 'undefined') {
                console.error('❌ ERRO: Biblioteca bcrypt não carregada');
                alert('Erro: Biblioteca bcrypt não foi carregada. Tente recarregar a página.');
            } else {
                console.log('✅ bcrypt carregado');
            }
        }, 2000);
    </script>
    
    <script src="../assets/js/config.js"></script>
    <script src="../assets/js/utils.js"></script>
    <script src="../assets/js/api.js"></script>
    <script src="../assets/js/admin.js"></script>
</body>
</html>
